{
  "id": "875793f8",
  "title": "Compiler: strict SMIL-to-DOM target validation and reporting",
  "tags": [
    "compiler",
    "smil",
    "validation",
    "p0"
  ],
  "status": "closed",
  "created_at": "2026-02-06T16:24:27.569Z"
}

Add explicit checks that each SMIL `textRef` target maps to real rendered content and that mapping is consistent.

## Why
Prevents silent desynchronization when fragment IDs or structure don’t line up.

## Acceptance criteria
- Report unresolved `textRef` targets with chapter/span context.
- Report spans with timing but no mapped geometry/text.
- Configurable mode: warn (default) vs fail compilation (`--strict`).

## Progress update (2026-02-09)
Implemented strict SMIL-to-DOM validation + reporting in compiler.

### Implemented
1. Added `compiler/src/validation/smil-targets.ts`
   - Validates each SMIL span `textRef` against normalized chapter DOM targets.
   - Reports unresolved targets with context: `chapterId`, `spanId`, `textRef`.
   - Detects timed spans with no mapped page geometry/text.
   - Emits grouped summary counts:
     - unresolved `textRef` targets
     - timed spans without geometry/text

2. Added `--strict` mode for `compile`
   - CLI option: `node dist/index.js compile ... --strict`
   - Default mode: warnings only.
   - Strict mode: fails compilation when SMIL validation issues exist.

3. Integrated validation into compile pipeline
   - New compile step: `Step 5b: Validating SMIL-to-DOM target mapping...`
   - Runs after pagination and before split/compact/write.

4. Tightened XHTML span mapping consistency
   - Updated `compiler/src/epub/xhtml.ts` so `data-span-id` mapping only applies when:
     - span `chapterId` matches
     - `textRef` path matches the current chapter XHTML path
     - fragment exists
   - Prevents accidental mapping from path-mismatched `textRef`s.

5. Tests
   - Added `compiler/test/smil-target-validation.test.ts` covering:
     - success path
     - missing fragment (`#id` absent)
     - path mismatch
     - fragment not found
     - timed span missing geometry/text
   - Extended `compiler/test/xhtml-normalization.test.ts` with path-mismatch mapping guard.

### Verification
- `cd compiler && npm run build` ✅
- `cd compiler && npm test` ✅ (27 tests passing)
- Manual strict smoke:
  - Good fixture passes under `--strict`
  - Corrupted fixture fails under `--strict` with span/chapter-specific diagnostics

## Follow-up update (2026-02-09, later)
Added compact issue-code summary table to SMIL validation logging.

### What changed
- `compiler/src/validation/smil-targets.ts`
  - Added `summarizeSmilIssuesByCode()` helper.
  - `logSmilToDomValidationResult()` now prints a compact table:
    - issue code
    - count

### Test coverage
- Extended `compiler/test/smil-target-validation.test.ts`
  - Added test for grouped issue-code count summary.

### Verification
- `cd compiler && npm run build` ✅
- `cd compiler && npm test` ✅
- Manual strict compile on intentionally corrupted fixture shows table in output.
