{
  "id": "7c19369a",
  "title": "Fix SMIL textRef/chapter path matching to handle URI-equivalent and fragment-only refs",
  "tags": [
    "compiler",
    "review",
    "smil"
  ],
  "status": "closed",
  "created_at": "2026-02-13T19:33:39.572Z"
}

Code review finding ([P1]): `compiler/src/epub/xhtml.ts` currently requires strict string equality between `textRefPath` and chapter XHTML path.

### Problem
Equivalent references can differ syntactically (e.g. percent-encoded path segments), and fragment-only refs should resolve to the current chapter. With strict raw equality, valid spans are skipped and never get `data-span-id`.

### Impact
Missing span mapping causes absent highlights/seek targets and possible audio-text desync in affected EPUBs.

### Suggested fix
- Normalize/URI-decode path segments before comparison.
- Treat empty `textRef` path (fragment-only refs) as same-document reference.
- Add regression tests with encoded path + fragment-only textRef inputs.

### Completed
- Updated `compiler/src/epub/xhtml.ts` span target matching to use chapter-path equivalence instead of strict raw string equality.
- Added path-comparison helpers:
  - percent-decodes path segments before comparison,
  - normalizes path separators / dot segments,
  - treats fragment-only textRefs (`#id`) as same-document references.
- Added regression coverage in `compiler/test/xhtml-normalization.test.ts`:
  - URI-encoded chapter path (`OPS/chapter%201.xhtml#frag1`) maps to chapter `OPS/chapter 1.xhtml`.
  - fragment-only textRef (`#frag1`) maps to the current chapter.
- Verified with:
  - `cd compiler && npm test -- xhtml-normalization.test.ts`
  - `cd compiler && npm test`
  - `cd compiler && npm run build`
