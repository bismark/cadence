{
  "id": "47ad2a66",
  "title": "Compiler: parse EPUB navigation (nav/ncx) for real TOC titles",
  "tags": [
    "compiler",
    "toc",
    "p0"
  ],
  "status": "closed",
  "created_at": "2026-02-06T16:24:27.573Z"
}

Replace placeholder TOC entries (`chapter.id`) with real chapter titles from EPUB nav document / NCX fallback.

## Why
Low effort, clear UX value.

## Acceptance criteria
- Use EPUB3 nav if present; fallback to NCX when needed.
- Map each TOC entry to first compiled page index for that section.
- Preserve reading order and nested hierarchy where practical.

## Completion notes (2026-02-12)
- Added EPUB navigation parsing in `compiler/src/epub/toc.ts`.
  - Uses EPUB3 nav document (`manifest item properties="nav"`) when present.
  - Falls back to NCX (`application/x-dtbncx+xml`, including `spine@toc` lookup) when nav is unavailable.
- Updated OPF parsing (`compiler/src/epub/opf.ts`) to expose `navPath` and `ncxPath` on `OPFPackage` and capture manifest `properties`.
- Replaced placeholder ToC generation in both `compile` and `align` pipelines with `buildTocEntries(...)`.
- ToC entries now include optional hierarchy depth (`level`) so nested nav/NCX structure is preserved in reading order while keeping backward-compatible fields (`title`, `pageIndex`).
- Added tests in `compiler/test/toc.test.ts` covering:
  - OPF nav/NCX path extraction
  - EPUB3 nav title + hierarchy mapping
  - NCX fallback behavior when nav is unavailable
- Verification run:
  - `cd compiler && npm run build`
  - `cd compiler && npm test -- toc.test.ts`
