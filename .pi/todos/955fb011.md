{
  "id": "955fb011",
  "title": "[P1] Restrict Playwright pagination to EPUB-local resources only",
  "tags": [
    "compiler",
    "security",
    "pagination",
    "p1"
  ],
  "status": "closed",
  "created_at": "2026-02-10T05:56:49.081Z"
}

During pagination we now preserve `<link rel="stylesheet">` from EPUB content and inject a `<base>` pointing at `https://epub.local`. The route handler only intercepts `https://epub.local/**`, so absolute URLs in EPUB content can still trigger external requests from Chromium.

## Why this matters
This allows untrusted EPUB input to cause outbound/internal network fetches (SSRF/privacy risk) and can make compiles non-deterministic.

## Scope
- `compiler/src/layout/paginate.ts`
- `compiler/src/epub/xhtml.ts` (where stylesheet links are preserved)

## Acceptance criteria
- All network requests during pagination are blocked by default.
- Only virtual EPUB-origin resources (`https://epub.local/**`) are allowed.
- Non-EPUB requests fail explicitly with clear diagnostics.
- Add regression test(s) with an EPUB containing an absolute stylesheet URL to verify no outbound fetch occurs.

Implemented in pagination routing.

### Changes
- Updated `compiler/src/layout/paginate.ts` to enforce **deny-by-default request routing** during Playwright pagination:
  - Routing now uses `page.route('**/*', ...)` (all requests), not only `https://epub.local/**`.
  - Added request classifier `classifyPaginationRequestUrl()`:
    - allows only `https://epub.local/**` as EPUB resources
    - allows inline `data:`/`blob:` resources
    - blocks all other origins/URLs as non-EPUB requests
- Added explicit fatal diagnostics for blocked requests:
  - records chapter + source context (`chapter=<id>, source=<referer/xhtmlPath>`) and reason
  - fulfills blocked requests with `403`
  - compile now fails via `throwOnPaginationRoutingFailures()` when fatal issues are detected
- Added test coverage in `compiler/test/pagination-resource-policy.test.ts`:
  - regression for absolute external stylesheet URL (`https://example.com/theme.css`) being classified as blocked
  - route-handler test asserting blocked external request is recorded as fatal and fulfilled with 403

### Notes
- No `xhtml.ts` filtering was required for this fix because routing now enforces origin policy regardless of preserved `<link rel="stylesheet">` values.
