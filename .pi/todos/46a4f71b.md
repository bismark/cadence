{
  "id": "46a4f71b",
  "title": "[P1] Fix CLI entrypoint detection for symlink/wrapper execution",
  "tags": [
    "compiler",
    "cli",
    "bug",
    "P1"
  ],
  "status": "closed",
  "created_at": "2026-02-13T19:42:29.371Z"
}

`compiler/src/index.ts` currently gates `program.parse()` with `isCliEntrypoint()` by comparing `import.meta.url` to `pathToFileURL(process.argv[1]).href`.

When the CLI is executed through a symlink/wrapper (common for npm bin commands), `import.meta.url` resolves to the real file path while `argv[1]` can remain the symlink path. The comparison fails, so `program.parse()` is skipped and the CLI exits without running commands.

## Fix
Normalize both paths with realpath (or equivalent robust entrypoint check) before comparison.

## Acceptance
- `cadence-compile --help` works when launched via symlinked bin path.
- Direct execution still works.
- Importing `index.ts` in tests still does not trigger command parsing.

### Completed
- Updated `compiler/src/index.ts` entrypoint detection to compare canonical realpaths instead of raw URL/path strings.
- Added `isCliEntrypoint(argv, moduleUrl)` parameters for deterministic unit testing while keeping default runtime behavior.
- Added regression tests in `compiler/test/cli-entrypoint.test.ts` covering:
  - direct execution,
  - symlinked wrapper/bin execution,
  - imported-module mismatch,
  - missing argv entrypoint.
- Verified:
  - `cd compiler && npm test` passes.
  - `node dist/index.js --help` works.
  - `cadence-compile` invoked via a symlink to `dist/index.js` prints help correctly.
