{
  "id": "2af58909",
  "title": "Compiler: concatenate audio in first span-use order (not manifest order)",
  "tags": [
    "compiler",
    "audio",
    "p1"
  ],
  "status": "closed",
  "created_at": "2026-02-06T16:24:27.575Z"
}

Build concatenation order from first appearance in the timed span stream rather than OPF manifest order.

## Why
Some books have manifest ordering that differs from playback intent.

## Acceptance criteria
- Audio concatenation order derives from sorted spans.
- Offsets remain deterministic and validated.
- Add regression test fixture where manifest order is intentionally misleading.

Implemented in compiler:

- Added `getAudioFilesInFirstSpanUseOrder(opf, spans)` in `compiler/src/epub/opf.ts`.
  - Derives concatenation order from first appearance in the **timed** span stream.
  - Appends manifest-only audio files afterward in original manifest order to keep deterministic output.
- Updated compile pipeline in `compiler/src/index.ts` Step 7 to use span-derived ordering:
  - `const audioFiles = getAudioFilesInFirstSpanUseOrder(opf, spans)`
- Added regression fixture with intentionally misleading manifest order:
  - `compiler/test/fixtures/misleading-manifest-audio-order.json`
- Added regression tests:
  - `compiler/test/audio-order.test.ts`
  - Verifies first-span-use ordering beats manifest order.
  - Verifies deterministic fallback to manifest order when no timed spans exist.

Verification run:
- `cd compiler && npm test` (all passing)
- `cd compiler && npm run build` (passing)
