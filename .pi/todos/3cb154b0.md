{
  "id": "3cb154b0",
  "title": "Create audio preprocessing module",
  "tags": [
    "audio",
    "ffmpeg"
  ],
  "status": "closed",
  "created_at": "2026-02-01T07:24:53.818Z"
}

# Create audio preprocessing module - DONE

Expanded `compiler/src/align/audio.ts` with:

## Functions

| Function | Purpose |
|----------|---------|
| `getTrackDuration(path)` | Get duration in seconds via ffprobe |
| `getChapters(path)` | Extract chapter info from m4b/mp4 |
| `splitTrack(input, start, end, output)` | Split audio by time range |
| `extractChapters(input, outputDir)` | Extract all chapters to files |
| `getTracksFromDirectory(dir)` | Get sorted audio files from folder |
| `prepareAudioTracks(input, tempDir)` | Main entry - handles all input types |

## Usage

```typescript
import { prepareAudioTracks } from './align/index.js';

// Single m4b with chapters -> extracts to temp dir
const tracks = await prepareAudioTracks('book.m4b', '/tmp/chapters');

// Directory of mp3s -> returns sorted list
const tracks = await prepareAudioTracks('./audiobook/', '/tmp/unused');

// Single mp3 (no chapters) -> returns as-is
const tracks = await prepareAudioTracks('book.mp3', '/tmp/unused');

// Each track has: { path, duration, title? }
for (const track of tracks) {
  const transcription = await transcribe(track.path);
}
```

## Implementation
- Uses ffprobe for chapter info and duration
- Uses ffmpeg with `-c copy` for fast splitting (no re-encoding)
- Handles m4b, mp3, ogg, flac, wav, etc.
