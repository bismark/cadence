{
  "id": "184f4bf7",
  "title": "Reduce highlight updates to a single refresh when switching spans",
  "tags": [
    "player",
    "performance",
    "eink"
  ],
  "status": "closed",
  "created_at": "2026-02-05T15:49:38.693Z"
}

Goal: When the active span changes (next sentence), update highlights in a single refresh so the old sentence unhighlights at the same time as the next sentence highlights. Avoid multiple e-ink refreshes per sentence change.

Notes:
- Investigate highlight update flow in PlayerScreen/PageRenderer; ensure state updates are batched.
- Consider deferring UI update until both old/new span IDs are ready, or update only when span actually changes.

Reference: player/app/.../ui/PlayerScreen.kt and PageRenderer.kt highlight logic.

## Completed (2026-02-10)
- Updated `player/app/src/main/java/com/cadence/player/ui/PlayerScreen.kt` to batch cursor/highlight state updates so span transitions can paint in a single refresh.

### Key changes
- Added `updatePlaybackCursor(span, pageIndex)` helper using `Snapshot.withMutableSnapshot { ... }` to atomically update:
  - `activeSpan`
  - `currentPageIndex`
- Poll loop now stages updates and applies them in one snapshot commit:
  - staged `positionMs`
  - staged span/page transition (`pendingSpanUpdate`, `pendingPageIndex`)
- Span/page updates are now only staged when something actually changed (`spanChanged || pageChanged`).
- Reused atomic cursor updates in other transition paths to avoid intermediate highlight/page states:
  - startup initial-page jump
  - restore-from-saved-position
  - playback-end jump to final page/span
  - `seekToSpan(...)`
  - `jumpToPage(...)`
  - `handlePlayPause()` when resuming in a valid span

### Result
- Old highlight removal and new highlight draw are applied together from a single state commit path.
- Avoids intermediate frames where highlight/page can be momentarily out of sync.

## Verification
- Ran required player checks:
  - `cd player && ./scripts/verify.sh`
- Result: PASS (`compileDebugKotlin`, `detekt`, `lintDebug`, `buildHealth`).
