{
  "id": "f58bc4b6",
  "title": "Move e-ink text color handling from player runtime to compiler output",
  "tags": [
    "compiler",
    "player",
    "eink",
    "rendering",
    "refactor"
  ],
  "status": "closed",
  "created_at": "2026-02-10T05:27:53.098Z"
}

Shift CSS color parsing and grayscale conversion out of the Android player and into the compiler pipeline.

## Why
- Keep player runtime minimal and deterministic on e-ink devices.
- Ensure style-to-ink mapping is compile-time stable.
- Reduce device-side parsing work and edge-case handling.

## Proposed approach
- During pagination in compiler, normalize computed text color to canonical e-ink grayscale (alpha composited onto white page background).
- Persist canonical grayscale value in page text run style (e.g. `inkGray`), with clear schema/version update.
- Update player renderer to prefer canonical grayscale value and avoid CSS color parsing.
- Keep temporary backward compatibility path for older bundles lacking canonical grayscale.

## Acceptance criteria
- `MOA-NAV-100` and similar styles render with expected gray tone in player without runtime CSS color parsing.
- Player color path can be simplified to direct grayscale drawing for new bundles.
- Existing bundles continue to load via fallback behavior until migration is complete.

## Implementation notes (2026-02-09)
- Compiler now computes canonical e-ink grayscale at pagination time from `getComputedStyle(...).color` and stores it as `style.inkGray` (0..255) in page text runs.
- `TextStyle` schema updated in compiler types to include `inkGray` while retaining original `color` string for debug/backward compatibility.
- Player `TextStyle` model updated with optional `inkGray`.
- Player renderer now prefers `inkGray` directly (no CSS color parsing for new bundles), with legacy fallback parser only when `inkGray` is absent.
- Recompiled `Advanced-Accessibility-Tests-Media-Overlays-v1.0.0.epub`; verified `MOA-NAV-100` has `inkGray: 128` in bundle JSON and renders gray on device.
- Validation steps passed: `compiler` build+tests, `player` Kotlin compile, app install, push bundle, on-device screenshot check.

## Follow-up adjustments (2026-02-09, fast-mode preference)
- Removed backward-compatibility parsing path in player entirely; bundles now require `style.inkGray`.
- Removed `style.color` from compiler/player text-style schema for runtime path.
- Added compiler grayscale quantization for speed/refresh stability with `EINK_GRAY_LEVELS = 4` (values quantized to 0/85/170/255).
- Player render path now uses direct grayscale integer only (`inkGray`) for minimal runtime work.
