{
  "id": "68f1f3e4",
  "title": "Compiler: preserve publisher CSS selectively, then apply profile overrides",
  "tags": [
    "compiler",
    "layout",
    "p0"
  ],
  "status": "closed",
  "created_at": "2026-02-06T16:24:27.567Z"
}

Improve XHTML normalization/rendering so we keep useful publisher CSS while still enforcing device profile constraints.

## Why
Current normalization strips too much styling and can degrade layout.

## Acceptance criteria
- Book CSS is loaded by default for reflowable content.
- Profile CSS remains authoritative for viewport/margins/font policy.
- Add a safe-list/deny-list for problematic rules (e.g. scripts/unsafe constructs).
- Document precedence rules between publisher CSS and profile CSS.

## Completed implementation (2026-02-12)
- Preserved publisher CSS by default during XHTML normalization:
  - Kept package-local `<link rel="stylesheet">` hrefs
  - Preserved inline `<style>` blocks and injected into normalized `<head>`
- Enforced CSS precedence explicitly in normalized chapter HTML:
  1. linked publisher stylesheets
  2. sanitized inline publisher style blocks
  3. profile CSS overrides
- Updated profile CSS policy (`generateProfileCSS`) so it is authoritative only for viewport/margins/base font policy using `!important`, while no longer globally resetting publisher typography/layout.
- Added CSS safety filtering and deny-list behavior:
  - Reject non-local stylesheet hrefs (`http(s):`, protocol-relative, other schemes)
  - Sanitize CSS by removing unsafe `@import` targets, rewriting unsafe `url(...)`, and stripping legacy scriptable declarations (`behavior`, `-moz-binding`, `expression(...)`)
  - Sanitize inline `style` attributes with same URL/declaration safeguards
  - Drop HTML event handler attributes and `javascript:` / `vbscript:` URL attributes during serialization
- Added stylesheet sanitization at pagination resource serving time (for linked CSS resources), with routing diagnostics warning entries when sanitization occurs.
- Documentation updated with precedence and safety rules:
  - `compiler/README.md` new **Publisher CSS handling (reflowable content)** section
- Tests added/updated:
  - `compiler/test/css-sanitization.test.ts` (new)
  - `compiler/test/xhtml-normalization.test.ts` (new sanitization + precedence coverage)
  - `compiler/test/pagination-resource-policy.test.ts` (stylesheet sanitization warning coverage)
- Verification:
  - `cd compiler && npm test` ✅
  - `cd compiler && npm run build` ✅
  - `cd compiler && node dist/index.js compile -i test/fixtures/Advanced-Accessibility-Tests-Media-Overlays-v1.0.0.epub --no-zip -o /tmp/cadence-css-preserve-test.bundle.zip` ✅
