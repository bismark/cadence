{
  "id": "48e2469e",
  "title": "Compact audio into single optimized file (OGG) and update timestamps",
  "tags": [
    "compiler",
    "audio",
    "optimization"
  ],
  "status": "closed",
  "created_at": "2026-02-01T04:56:07.648Z"
}

## Completed

Implemented single-file audio concatenation using FFmpeg and OGG Opus encoding.

### Compiler Changes

**New file: `compiler/src/audio/concat.ts`**
- `getAudioDuration()` - Uses ffprobe to get duration of each source file
- `concatenateAudio()` - Extracts audio from EPUB, concatenates with FFmpeg, outputs OGG Opus
- `applyAudioOffsets()` - Updates span timestamps to global offsets

**Modified: `compiler/src/bundle/writer.ts`**
- Replaced `copyAudioFiles()` with `concatenateAudio()` call
- Removed `buildAudioPathMap()` (no longer needed)
- Updated `writeSpansJsonl()` to omit `audioSrc` field
- Output is now single `audio.opus` file instead of `audio/*.mp3`

**Modified: `compiler/src/types.ts`**
- Removed `audioSrc` from `SpanEntry` interface

### Player Simplifications

**Modified: `Bundle.kt`**
- Removed `audioSrc` from `SpanEntry` data class
- Simplified `findSpanAtTime()` - no longer needs audioSrc filtering
- Added `audioPath` property for single file path
- Removed `findNextSpan()`, `findLastSpanInAudio()`, `getAudioPath()`

**Modified: `PlayerScreen.kt`**
- Removed `currentAudioSrc` state tracking
- Removed audio file ended handler
- Removed audio file switching logic
- ~40% code reduction

### Bundle Format Change
```
Before:                    After:
audio/                     audio.opus (single file)
  chapter1.mp3
  chapter2.mp3
  ...
```

### Audio Settings
- Codec: OGG Opus (libopus)
- Bitrate: 48kbps VBR
- Application: voip (optimized for speech)
