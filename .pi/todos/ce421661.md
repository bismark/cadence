{
  "id": "ce421661",
  "title": "[P1] Normalize canonical break-before/after values for column pagination",
  "tags": [
    "compiler",
    "pagination",
    "css-breaks",
    "p1"
  ],
  "status": "closed",
  "created_at": "2026-02-10T23:51:43.978Z"
}

`compiler/src/index.ts` currently only maps break values via `toColumnBreakValue()` for alias properties (`page-break-*`, `column-break-*`, `-webkit-column-break-*`).

Direct canonical declarations like `break-before: page` / `break-after: always` are preserved unchanged, but Chromium multi-column pagination does not treat these values as forced column breaks.

## Impact
EPUBs authored with modern `break-before` / `break-after` hints can silently lose intended chapter/page boundaries during aligned pagination.

## Suggested fix
Apply value normalization for canonical `break-before`/`break-after` as well (e.g., map `page|always|left|right|recto|verso -> column`, `avoid-page -> avoid`) before emitting preserved break CSS.

## Acceptance
- `break-before: page` and `break-after: always` force expected column/page boundaries in aligned output.
- Existing alias handling remains intact.
- Add/extend tests for canonical and alias break declarations.

Implemented.

### Changes
- Updated break-hint normalization in `compiler/src/index.ts`:
  - Canonical `break-before` / `break-after` declarations now normalize values through `toColumnBreakValue()` (same mapping path used for aliases).
  - This maps `page|always|left|right|recto|verso -> column` and `avoid-page -> avoid` for canonical properties before emitting preserved CSS.
- Kept alias handling intact (`page-break-*`, `column-break-*`, `-webkit-column-break-*`).
- Added CLI-import safety in `compiler/src/index.ts` so tests can import helper functions without invoking command parsing:
  - `program.parse()` now runs only when `index.ts` is the direct entrypoint.
- Exported `extractBreakRulesFromCss` for targeted unit testing.
- Added tests in `compiler/test/break-hint-css.test.ts` covering:
  - canonical `break-before: page` and `break-after: always` normalization
  - alias preservation + canonical mapped declaration emission
  - canonical `break-after: avoid-page !important` normalization

### Verification
- `cd compiler && npm test`
- `cd compiler && npm run build`
