{
  "id": "e09cf9d7",
  "title": "[P1] Preserve source order when emitting publisher <link>/<style> blocks",
  "tags": [
    "compiler",
    "review",
    "css",
    "p1"
  ],
  "status": "closed",
  "created_at": "2026-02-13T20:03:37.632Z"
}

## Context
Code review on diff vs `reviewed` found that XHTML normalization now collects linked stylesheets and inline style blocks separately, then emits all links before all inline blocks.

## Problem
This reorders author CSS whenever the source `<head>` interleaves links and style tags (e.g. `link A -> style B -> link C` becomes `A -> C -> B`). That can change cascade precedence and therefore pagination geometry / span rect mapping.

## Location
- `compiler/src/epub/xhtml.ts`
  - extraction: around `extractPublisherStylesFromRawHTML`
  - emission: around `generateNormalizedHTML` (`stylesheetLinks` then `inlineStyles`)

## Expected fix
Preserve original source order for publisher style nodes when serializing normalized head content.

## Suggested acceptance criteria
- A test with interleaved `<link>` and `<style>` in source head preserves order in normalized output.
- Existing CSS sanitization behavior still applies to both linked and inline CSS.

### Completed
- Updated publisher CSS extraction in `compiler/src/epub/xhtml.ts` to preserve original `<head>` source order across interleaved `<link>` and `<style>` nodes.
  - Extraction now parses the raw `<head>` fragment and walks nodes in-order.
  - Emission now serializes a single ordered publisher-style sequence before profile CSS.
- Kept existing sanitization behavior:
  - unsafe stylesheet hrefs are still blocked,
  - inline style blocks are still sanitized/dropped as before.
- Added regression test in `compiler/test/xhtml-normalization.test.ts`:
  - `preserves source order for interleaved publisher <link>/<style> nodes`
  - verifies `link A -> style B -> link C -> style D` order remains intact in normalized output,
  - verifies inline CSS sanitization still applies.
- Verified with:
  - `cd compiler && npm test -- xhtml-normalization.test.ts`
  - `cd compiler && npm test`
  - `cd compiler && npm run build`
  - `cd compiler && npx biome check src/epub/xhtml.ts test/xhtml-normalization.test.ts`
