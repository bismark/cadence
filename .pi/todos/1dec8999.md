{
  "id": "1dec8999",
  "title": "Fix findChapterOffset to handle case/punctuation differences",
  "tags": [
    "align",
    "bug",
    "P1"
  ],
  "status": "closed",
  "created_at": "2026-02-02T05:23:02.224Z"
}

# Chapter offset detection - FIXED

## Problem (was)
`findChapterOffset()` failed to match early sentences due to:
- Whitespace: EPUB has `\n      ` vs transcript single spaces
- Punctuation: EPUB "years ago—" vs transcript "years ago,"

## Fix Applied
Added text normalization before fuzzy matching:
```typescript
const normalizeText = (s: string) =>
  s.toLowerCase()
    .replace(/[\r\n\t]+/g, " ")   // Collapse newlines
    .replace(/\s+/g, " ")          // Collapse spaces
    .replace(/[—–]/g, "-")         // Normalize dashes
    .replace(/['']/g, "'")         // Normalize quotes
    .replace(/[""]/g, '"')
    .trim();
```
Also increased fuzzy threshold from 10% to 15%.

## Result
- Before: Matched at offset 1220, sentence 594 (~98s)
- After: Matched at offset 241, sentence 585 (~26s)
- "Call me Ishmael" now aligns correctly at ~29s
