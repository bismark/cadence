{
  "id": "6b7ef95d",
  "title": "Restrict SMIL target ID extraction to actual `id` attributes (not `data-span-id`)",
  "tags": [
    "compiler",
    "review",
    "validation"
  ],
  "status": "closed",
  "created_at": "2026-02-13T19:33:39.575Z"
}

Code review finding ([P2]): `compiler/src/validation/smil-targets.ts` uses regex `\bid\s*=` to collect IDs from HTML.

### Problem
This pattern also matches attributes like `data-span-id`, so span IDs can be mistaken as DOM fragment IDs.

### Impact
`smil_textref_fragment_not_found` can be suppressed incorrectly, causing `--strict` validation to pass broken mappings.

### Suggested fix
- Parse HTML and read exact `id` attributes, or tighten matching to true attribute boundaries.
- Add tests proving `data-span-id` is ignored and only real `id` values are indexed.

### Completed
- Replaced regex-based ID extraction in `compiler/src/validation/smil-targets.ts` with parse-tree traversal using `parse5`.
- Validation now indexes only exact `id` attributes from HTML elements; attributes like `data-span-id` are no longer treated as fragment IDs.
- Added regression test in `compiler/test/smil-target-validation.test.ts`:
  - `indexes only real id attributes and ignores data-span-id`
  - verifies `smil_textref_fragment_not_found` is reported when only `data-span-id` is present.
- Verified with:
  - `cd compiler && npm test -- smil-target-validation.test.ts`
  - `cd compiler && npm test`
  - `cd compiler && npm run build`
  - `cd compiler && npx biome check src/validation/smil-targets.ts`
