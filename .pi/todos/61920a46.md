{
  "id": "61920a46",
  "title": "Align command: reconcile audio handling with compile command",
  "tags": [
    "align",
    "architecture",
    "audio",
    "P1"
  ],
  "status": "closed",
  "created_at": "2026-02-02T04:13:25.385Z"
}

# Audio handling inconsistency - FIXED

## Changes Made

### 1. Added `concatenateAudioFiles()` to `src/audio/concat.ts`
- New function that works with direct file paths (not EPUBContainer)
- Concatenates audio files to single OGG Opus file
- Returns offset map for timestamp adjustment

### 2. Updated `writeBundleAlignedUncompressed()` in `src/index.ts`
- Now concatenates audio to single `audio.opus` (like compile command)
- Applies audio offsets to spans
- Writes spans in same format as compile (`clipBeginMs`, `clipEndMs`, `pageIndex`)
- Removed `audio/` directory and per-file copying

### 3. Fixed `start = 0` override in `getSentenceRanges.ts`
- Removed forced `start = 0` for first sentence
- Preserves actual STT timestamps
- Handles audio with intros (like LibriVox) correctly
- Changed `let start` to `const start`

## Result
Both `compile` and `align` commands now output identical bundle format:
- Single `audio.opus` file
- Spans with absolute timestamps into concatenated audio
- Consistent player logic
