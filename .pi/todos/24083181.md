{
  "id": "24083181",
  "title": "[P2] Fix EPUB3 nav parser to handle wrapped nav lists",
  "tags": [
    "compiler",
    "review",
    "toc",
    "P2"
  ],
  "status": "closed",
  "created_at": "2026-02-13T19:53:29.124Z"
}

## Problem
`buildTocEntries()` in `compiler/src/epub/toc.ts` currently expects:
- `<ol>/<ul>` to be direct children of `<nav>`, and
- nested `<ol>/<ul>` to be direct children of `<li>`.

Valid EPUB3 nav documents often wrap these lists in container elements (e.g. `<div>`, `<section>`). In those cases the parser misses entries and falls back to spine IDs, producing incorrect ToC titles/hierarchy.

## Why it matters
This causes incorrect navigation metadata for books with standards-compliant but wrapped nav markup.

## Suggested fix
- In `parseNavDocument`, locate the first descendant `<ol>`/`<ul>` inside the selected nav node (not just direct children).
- In `parseHtmlTocList`, locate descendant child lists that belong to the current `<li>` (while avoiding lists nested under deeper `<li>` descendants where appropriate).
- Keep current href/title filtering behavior.

## Acceptance criteria
- A nav doc with `<nav><div><ol>...</ol></div></nav>` yields ToC entries from nav (no fallback to spine IDs).
- A nav doc with `<li><div><a ...></a><ol>...</ol></div></li>` preserves parent/child hierarchy levels.
- Existing ToC tests continue to pass.
- Add a test fixture/case covering wrapped list structures.

### Completed
- Updated EPUB3 nav parsing in `compiler/src/epub/toc.ts` to handle wrapped nav list structures:
  - `parseNavDocument` now finds the first descendant `<ol>/<ul>` under the selected `<nav>` (not just direct children).
  - `parseHtmlTocList` now finds descendant child lists that belong to each `<li>`, including wrapped structures like `<li><div>...<ol>...</ol></div></li>`.
  - Child-list discovery stops at nested `<li>` descendants so deeper lists remain scoped to their own parents.
- Added regression coverage in `compiler/test/toc.test.ts`:
  - wrapped root list case: `<nav><div><ol>...` uses nav titles (no fallback to spine IDs),
  - wrapped child list case: `<li><div><a...></a><ol>...</ol></div></li>` preserves hierarchy levels (parent level 0, child level 1).
- Verified with:
  - `cd compiler && npm test -- toc.test.ts`
  - `cd compiler && npm test`
  - `cd compiler && npm run build`
  - `cd compiler && npx biome check src/epub/toc.ts test/toc.test.ts`
