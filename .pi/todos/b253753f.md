{
  "id": "b253753f",
  "title": "Investigate bundle format compaction (styles/IDs/redundancy)",
  "tags": [
    "compiler",
    "bundle-format",
    "optimization"
  ],
  "status": "closed",
  "created_at": "2026-02-10T23:49:11.732Z"
}

## Context
User asked whether output bundle can be more concise and noted repeated font names and EPUB-derived IDs (e.g. `pg_header_*`).

## Findings (baseline from fixture)
Using `compiler/test/fixtures/moby-dick-aligned.bundle`:
- Uncompressed bundle total: ~21.99 MB
- `pages/`: ~13.22 MB (largest component in extracted bundle)
- `audio.opus`: ~8.72 MB
- In ZIP, audio dominates shipped size (~8.71 MB compressed) while pages still ~1.52 MB compressed.

Estimated page-data reductions:
- Pretty JSON -> minified JSON: ~13.22 MB -> ~7.93 MB
- Style dictionary (`styleId` per run) + shared styles table: ~5.32 MB
- Numeric span IDs (instead of repeated strings) in page payloads: ~4.65 MB

## Proposed scope
1. Add compact bundle schema variant for pages:
   - shared `styles` table
   - `styleId` on text runs
   - optional numeric span references in page payloads
2. Evaluate dropping/deriving optional page fields (`pageId`, `chapterId`, `firstSpanId`, `lastSpanId`) where safe.
3. Keep player as dumb painter; avoid adding runtime layout complexity.
4. Measure before/after:
   - bundle size (raw + zip)
   - player bundle load/parse timings
   - rendering correctness

## Non-goals for this task
- Do **not** implement yet (tracking/planning only).
- No backward-compat/version migration work unless explicitly requested.

## Acceptance criteria (when eventually implemented)
- Functional parity in player behavior (page render, highlighting, tap-to-seek, navigation)
- Documented schema changes in `docs/bundle-format.md`
- Verified size and load-time comparison table for at least one medium/large fixture

## Progress update (2026-02-10)
Implemented **phase 1** in compiler:

1. **Compact span IDs in output bundle**
   - Added `compiler/src/bundle/compact-span-ids.ts`.
   - Replaces verbose source IDs with deterministic short IDs (`s0`, `s1`, `s2`, ...).
   - Applied after page-split processing in both `compile` and `align` pipelines.
   - Rewrites IDs consistently in:
     - `spans` entries
     - `page.spanRects[].spanId`
     - `page.textRuns[].spanId`
     - `page.firstSpanId` / `page.lastSpanId`

2. **Minify JSON payloads written to bundle**
   - Removed pretty-print spacing in compiler bundle writers for:
     - `meta.json`
     - `toc.json`
     - `pages/*.json`
   - Applied to both compile path (`compiler/src/bundle/writer.ts`) and align path (`compiler/src/index.ts` aligned writer).

3. **Docs update (bundle IDs semantics)**
   - Updated `docs/bundle-format.md` examples to use compact IDs (`s0`, `s1`, ...).
   - Clarified span IDs are internal compiler-assigned identifiers with no EPUB-semantic meaning.

### Verification
- `cd compiler && npm run build` passes.
- Manual compile smoke test succeeded on Advanced Accessibility fixture.
- Sample output shows minified JSON and compact span IDs in both `spans.jsonl` and page references.

### Remaining high-impact follow-ups
- Style dictionary (`styleId` + shared style table) to remove repeated style objects.
- Optional numeric span references in page payloads (if/when player changes are accepted).

## Progress update (2026-02-10, phase 2)
Implemented style deduplication in emitted bundles.

### Compiler changes
- Added `compiler/src/bundle/compact-page-styles.ts`
  - Deduplicates `TextStyle` across all pages.
  - Rewrites each text run from embedded `style` object to `styleId`.
- Updated bundle writers to emit:
  - `styles.json` (shared style table)
  - `pages/*.json` with `textRuns[].styleId`
- Applied to both compile and align outputs:
  - `compiler/src/bundle/writer.ts`
  - aligned writer path in `compiler/src/index.ts`

### Supporting tooling updates
- Updated compiler preview/inspect loader path to resolve `styleId` via `styles.json` before rendering/inspection (`compiler/src/preview.ts`).

### Validation
- `cd compiler && npm run build` passed.
- Compile smoke test passed on Advanced Accessibility fixture.
- `inspect` command works on new output.

### Measured impact (Advanced fixture sample)
- `pages/` directory: ~152 KB -> ~104 KB after style table + styleId (plus `styles.json` 525 B).
- Full extracted bundle remains audio-dominated, but page payload dropped materially.

## Closure decision (2026-02-10)
Primary compaction goals are complete for current POC scope:
- compact span IDs
- minified JSON output
- shared style table (`styles.json`) + `styleId` references
- compiler/player/docs updated and validated, including Moby Dick runtime test

Remaining ideas (numeric span refs, dropping optional page metadata) measured as low ROI (~0.04% to ~2% page payload savings on Moby fixture) and are not required for this task.
