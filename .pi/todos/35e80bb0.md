{
  "id": "35e80bb0",
  "title": "Instrument player runtime and identify optimization opportunities",
  "tags": [
    "player",
    "performance",
    "instrumentation"
  ],
  "status": "closed",
  "created_at": "2026-02-06T03:47:36.500Z"
}

User requested instrumentation on the Android player to find optimization options. Plan:
1. Inspect current player update/render/audio polling loops for hotspots.
2. Add lightweight runtime instrumentation (timings/counters) around likely hotspots.
3. Summarize measured or inferred optimization opportunities.
4. Keep instrumentation gated to debug builds/log tags to avoid release overhead.

## Work completed
- Added reusable debug-only performance logging utilities in `player/app/src/main/java/com/cadence/player/perf/PerfStats.kt`.
- Instrumented `PlayerScreen` polling loop:
  - Poll-loop timing (avg/min/max every 200 loops)
  - Span lookup timing (avg/min/max every 200 lookups)
  - Save-position timing (avg/min/max every 20 saves)
  - Periodic summary counters (lookups/span switches/page switches)
- Instrumented `BundleLoader` load stages:
  - Resolve bundle dir, meta parse, spans parse, pages parse, toc parse, total load
  - Zip cache-hit/extract timing and entry count
- Instrumented `AudioPlayer` state transitions and key commands (load/play/pause/seek/release).
- Instrumented `PageRenderer`:
  - Draw duration stats per page
  - Tap hit-test timing
  - Recomposition counters (every 100 recompositions)
- Added two low-risk optimizations while instrumenting:
  - Reused `Paint` objects per text style (removed per-run allocations in draw loop)
  - Indexed `page.spanRects` by `spanId` once per page to avoid repeated linear scans for active highlight

## Validation
- `cd player && ./gradlew assembleDebug` passes successfully.

## Next suggested runtime check
- Run app on device/emulator and inspect logs with tag `CadencePerf`.
- Focus on: `page-draw[...]`, `poll-loop`, and `bundle load ...` lines for hotspots.

## Runtime measurement (device/emulator)
Collected logs from `adb logcat -s CadencePerf` while playing.

### Baseline findings (before latest UI-throttle tweak)
- Bundle load: ~143–153ms total on current test bundle (69 pages, 754 spans)
  - Pages JSON parse dominates (~110ms)
- Poll loop: ~0.05–0.18ms avg per 50ms tick
- Canvas draw: ~0.29–0.51ms avg (`page-draw`), occasional spikes up to ~5.62ms
- Recomposition rate while playing: ~19.5/sec (almost same as 20Hz poll)
  - Indicates `positionMs` updates were driving near-constant recomposition/redraw

### Additional optimization implemented after measuring
- Prevent duplicate startup bundle load by guarding one-shot bundle load effect in `CadenceApp`.
- Throttle `positionMs` UI-state updates to ~1Hz while keeping 20Hz span/page sync logic.
  - This significantly cuts unnecessary recompositions/redraws when active span/page do not change.
  - Post-change run produced no `page-draw` / recomposition report buckets (threshold not reached), indicating drastically fewer redraws.
