{
  "id": "5458fa3d",
  "title": "[P0] Move text baseline computation to compiler output (baselineY)",
  "tags": [
    "compiler",
    "bundle-format",
    "rendering",
    "p0"
  ],
  "status": "closed",
  "created_at": "2026-02-10T17:55:20.516Z"
}

Goal: align with architecture rule "player is a dumb painter" by precomputing text run baseline in compiler.

Scope:
- Add `baselineY` to compiler `TextRun` schema (`compiler/src/types.ts`).
- Compute `baselineY` during pagination extraction in `compiler/src/layout/paginate.ts`.
- Keep coordinates as float precision.

Acceptance:
- Generated bundle pages include `baselineY` for every text run.
- Compiler build/tests pass and align command succeeds for fixture.

Implemented compiler-side baseline precomputation:

- Added `baselineY: number` to `TextRun` in `compiler/src/types.ts`.
- In `compiler/src/layout/paginate.ts`, added style-keyed descender estimation using Chromium canvas text metrics.
- During text-run flush, compute page-local baseline via:
  - `baselineY = y + height - descenderPx`
  - rounded to page precision.
- Included `baselineY` in run dedupe key.

Validation:
- `cd compiler && npm run build`
- `cd compiler && npm test`
- `cd compiler && node dist/index.js align ... -o /tmp/moby-dick-aligned-render-fidelity-v12.bundle`
- Verified output pages now include `baselineY` for each text run (e.g. page 34).
