{
  "id": "a15410e0",
  "title": "Ensure player auto-advances to next page during audio playback",
  "tags": [
    "player",
    "audio",
    "bug"
  ],
  "status": "closed",
  "created_at": "2026-02-01T04:44:29.001Z"
}

## Issue
During continuous audio playback, the player should automatically turn to the next page when all spans on the current page have been read.

## Root Cause
Two bugs were found:

1. **`findSpanAtTime` didn't filter by audio source**: Each audio file has its own timeline starting from 0. Without filtering by `audioSrc`, the function could return a span from a different audio file with overlapping timestamps.

2. **No handling for audio file transitions**: When one audio file ended, there was no mechanism to automatically load and play the next audio file.

## Solution

### 1. Fixed `findSpanAtTime` (Bundle.kt)
- Added `audioSrc` parameter to filter spans by the currently playing audio file
- Updated signature: `findSpanAtTime(timestampMs: Double, audioSrc: String?)`

### 2. Added audio file transition handling (AudioPlayer.kt)
- Added `playbackEnded` StateFlow that emits `true` when ExoPlayer reaches STATE_ENDED
- Reset to `false` when new audio is loaded (STATE_READY)

### 3. Added playback ended handler (PlayerScreen.kt)
- New `LaunchedEffect` listens for `playbackEnded` events
- When audio ends, finds the last span in current audio file
- Gets the next span (which may be in a different audio file)
- Loads new audio file, seeks to span's start time, and begins playback
- Updates page display if the next span is on a different page

### 4. Added helper methods (Bundle.kt)
- `findNextSpan(currentSpanId)`: Gets the next span in reading order
- `findLastSpanInAudio(audioSrc)`: Gets the last span in a given audio file

## Files Modified
- `player/app/src/main/java/com/cadence/player/data/Bundle.kt`
- `player/app/src/main/java/com/cadence/player/audio/AudioPlayer.kt`
- `player/app/src/main/java/com/cadence/player/ui/PlayerScreen.kt`

## Tasks
- [x] Check how current span's page assignment is tracked
- [x] Verify page transition logic triggers when span.page changes
- [x] Ensure highlight rects update correctly after page change
- [x] Handle audio file transitions at chapter boundaries
- [ ] Test on device (needs gradle wrapper)
